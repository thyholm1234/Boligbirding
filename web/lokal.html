<!-- Version: 1.8.10 - 2026-02-16 20.18.58 -->
<!-- © Christian Vemmelund Helligsø -->
<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Lokalafdeling – Scoreboard</title>
  <link rel="stylesheet" href="style.css?v=1.8.10">
  <style>
    .user-card { border:1px solid #ccc; border-radius:8px; padding:1em; margin-bottom:1em; cursor:pointer; background:#f8f9fa; }
    .user-card:hover { background:#e0f7fa; }
    .firsts-list { margin:1em 0 2em 1em; padding-left:0; }
    .firsts-list li { margin-bottom:0.3em; }
    .modal-bg { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal { background:#fff; border-radius:10px; padding:2em; max-width:400px; width:90vw; }
  </style>
</head>
<body>
  <h1>Scoreboard – Din lokalafdeling</h1>
  <button id="sync-all-btn" style="margin-bottom:1em;">Synkroniser alle brugere</button>
  <div id="scoreboard"></div>

  <div id="modal-bg" class="modal-bg" style="display:none;">
    <div class="modal">
      <button id="close-modal" style="float:right;">Luk</button>
      <h3 id="modal-title"></h3>
      <ul id="modal-list" class="firsts-list"></ul>
    </div>
  </div>

  <script>
  let lokalafdeling = null;

  async function getLokalafdeling() {
    const res = await fetch('/api/is_logged_in');
    const data = await res.json();
    if (!data.ok) window.location.href = "/login.html";
    return data.lokalafdeling;
  }

  async function visScoreboard() {
    lokalafdeling = await getLokalafdeling();
    const res = await fetch('/api/scoreboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        scope: 'lokal_matrikel',
        afdeling: lokalafdeling
      })
    });
    const data = await res.json();
    const rows = data.rows || [];
    const container = document.getElementById('scoreboard');
    if (!rows.length) {
      container.innerHTML = "<p>Ingen brugere fundet i din lokalafdeling.</p>";
      return;
    }
    let html = "";
    rows.forEach(row => {
      html += `
        <div class="user-card" data-obserkode="${row.obserkode}">
          <strong>#${row.placering} ${row.navn}</strong><br>
          Antal arter: ${row.antal_arter}<br>
          Sidste art: ${row.sidste_art ? row.sidste_art + (row.sidste_dato ? " (" + row.sidste_dato + ")" : "") : ""}
        </div>
      `;
    });
    container.innerHTML = html;

    // Tilføj klik-event til alle kort
    document.querySelectorAll('.user-card').forEach(card => {
      card.onclick = async function() {
        const kode = this.getAttribute('data-obserkode');
        await visUserFirsts(kode, this.querySelector('strong').innerText);
      };
    });
  }

async function visUserFirsts(obserkode, navn) {
  const res = await fetch('/api/obser', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      scope: 'user_global',
      obserkode: obserkode
    })
  });
  const data = await res.json();
  const firsts = data.firsts || [];
  const modalBg = document.getElementById('modal-bg');
  const modalTitle = document.getElementById('modal-title');
  const modalList = document.getElementById('modal-list');
  modalTitle.textContent = "Første observationer for " + navn;
  if (!firsts.length) {
    modalList.innerHTML = "<li>Ingen observationer fundet.</li>";
  } else {
    modalList.innerHTML = firsts.map(f =>
      `<li><strong>${f.artnavn}</strong> – ${f.lokalitet} – ${f.dato}</li>`
    ).join("");
  }
  modalBg.style.display = "flex";
}

  document.getElementById('close-modal').onclick = function() {
    document.getElementById('modal-bg').style.display = "none";
  };

  window.onclick = function(e) {
    if (e.target.id === "modal-bg") {
      document.getElementById('modal-bg').style.display = "none";
    }
  };

  document.getElementById('sync-all-btn').onclick = async function() {
    this.disabled = true;
    this.textContent = "Synkroniserer...";
    const res = await fetch('/api/full_sync_all', { method: 'POST' });
    const data = await res.json();
    alert(data.msg || "Synkronisering startet!");
    this.disabled = false;
    this.textContent = "Synkroniser alle brugere";
    visScoreboard();
  };

  // Hent scoreboard for DOF Østjylland, matrikel
  async function hentScoreboard() {
    const res = await fetch('/api/scoreboard', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({scope: "lokal_matrikel", afdeling: "DOF Østjylland"})
    });
    const data = await res.json();
    console.log(data.rows); // Array af brugere i scoreboardet
    return data.rows;
  }

  // Hent individuel brugers global-liste
  async function hentGlobalListe(obserkode) {
    const res = await fetch('/api/obser', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({scope: "user_global", obserkode})
    });
    const data = await res.json();
    console.log(data.firsts); // Array af brugerens første observationer
    return data.firsts;
  }

  // Eksempel på brug:
  (async () => {
    const scoreboard = await hentScoreboard();
    if (scoreboard.length > 0) {
      // Hent global-liste for første bruger i scoreboardet
      const firsts = await hentGlobalListe(scoreboard[0].obserkode);
      // Gør noget med firsts...
    }
  })();

  visScoreboard();
  </script>
</body>
</html>