<!-- Version: 1.10.9 - 2026-02-16 21.51.57 -->
<!-- © Christian Vemmelund Helligsø -->
<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Ankomstgraf for fugle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css?v=1.10.9">
  <script src="https://cdn.jsdelivr.net/npm/chart.js?v=1.10.9"></script>
  <script type="module">
    import { renderNavbar, initNavbar, initMobileNavbar } from './navbar.js';
    renderNavbar();
    initNavbar();
    initMobileNavbar();

    fetch('/api/get_grupper', { credentials: 'include' })
    .then(res => res.json())
    .then(grupper => {
        import('./navbar.js').then(mod => {
        mod.addGruppeLinks(grupper);
        });
    });
  </script>
</head>
<body>
  <main style="max-width:600px;margin:40px auto;padding:2em 1em 1em 1em;background:var(--card-bg);border-radius:16px;box-shadow:var(--card-shadow)">
    <h2 style="text-align:center;">Ankomstgraf for fugle</h2>
    <div style="margin-bottom:1em;text-align:center;">
      <label for="artDropdown"><b>Vælg fugleart:</b></label>
      <select id="artDropdown" style="min-width:220px;padding:0.4em 0.7em;font-size:1em;"></select>
    </div>
    <canvas id="ankomstChart" width="600" height="250"></canvas>
    <h3 style="margin-top:2em;text-align:center;">Sidste fund pr. matrikel</h3>
    <canvas id="sidsteFundChart" width="600" height="250"></canvas>
    <h3 style="margin-top:2em;text-align:center;">Observationer pr. turid pr. dag</h3>
    <canvas id="turidChart" width="600" height="250"></canvas>
    <div id="statistik" style="margin-top:1.5em;text-align:center;"></div>
  </main>
  <script>
    let chart = null, turidChart = null, sidsteFundChart = null;

    async function hentArter() {
      const res = await fetch('/api/matrikel_arter');
      const arter = await res.json();
      const dropdown = document.getElementById('artDropdown');
      dropdown.innerHTML = arter.map(a => `<option value="${a}">${a}</option>`).join('');
      if (arter.length) {
        dropdown.value = arter[0];
        hentArtData(arter[0]);
      }
    }

    async function hentArtData(artnavn) {
      const res = await fetch(`/api/artdata?artnavn=${encodeURIComponent(artnavn)}&scope=matrikel`);
      const data = await res.json();

      // Find alle datoer i datasættet (fra første til sidste dag)
      function getAllDates(start, end) {
        const arr = [];
        let dt = new Date(start);
        while (dt <= end) {
          arr.push(dt.toLocaleDateString('da-DK'));
          dt.setDate(dt.getDate() + 1);
        }
        return arr;
      }

      // Find min og max dato på tværs af alle grafer
      const allDates = [
        ...(data.ankomstgraf || []).map(d => d.dato),
        ...(data.obs_per_turid || []).map(d => d.dato),
        ...(data.sidste_fund || []).map(d => d.sidste_dato)
      ].filter(Boolean);
      const parse = s => {
        const [d, m, y] = s.split('-').map(Number);
        return new Date(y, m - 1, d);
      };
      let minDate, maxDate;
      if (allDates.length) {
        const years = allDates.map(s => Number(s.split('-')[2]));
        const minYear = Math.min(...years);
        minDate = new Date(minYear, 0, 1); // 1. januar i mindste år
        // maxDate = dags dato
        maxDate = new Date();
        maxDate.setHours(0,0,0,0); // undgå tid-forskel
      } else {
        minDate = new Date();
        maxDate = new Date();
      }
      const alleDage = getAllDates(minDate, maxDate);
      function toDashDate(date) {
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}-${m}-${y}`;
      }
      const labels = [];
      let dt = new Date(minDate);
      while (dt <= maxDate) {
        labels.push(toDashDate(dt));
        dt.setDate(dt.getDate() + 1);
      }

      // --- Ankomstgraf ---
      const ankomst = data.ankomstgraf || [];
      // Tæl hvor mange matrikler har ankomst_dato <= hver dag
      const ankomstValues = labels.map(dato =>
        ankomst.filter(a => {
          const [dd, mm, yyyy] = dato.split('-').map(Number);
          const d1 = new Date(yyyy, mm - 1, dd);
          const [ad, am, ay] = a.ankomst_dato.split('-').map(Number);
          const d2 = new Date(ay, am - 1, ad);
          return d2 <= d1;
        }).length
      );

      // Tegn ankomstgraf
      const ctx = document.getElementById('ankomstChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `Akkumuleret ankomst (${artnavn})`,
            data: ankomstValues,
            borderColor: '#2b7a78',
            backgroundColor: 'rgba(43,122,120,0.08)',
            pointRadius: 3,
            fill: true,
            tension: 0
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, title: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Dato' } },
            y: {
              title: { display: true, text: 'Antal matrikler' },
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                callback: v => Number.isInteger(v) ? v : null
              }
            }
          }
        }
      });

      // --- Sidste fund pr. matrikel ---
      const sidsteFundData = data.sidste_fund || [];

      // 1. Find antal unikke matrikler fundet senest på hver dato (brug kun sidste fund-dato for hver matrikel)
      const sidsteFundPerDate = {};
      const matrikler = new Set();
      sidsteFundData.forEach(d => {
        // Kun én gang pr. matrikel (hvis flere poster, brug den sidste)
        sidsteFundPerDate[d.sidste_dato] = (sidsteFundPerDate[d.sidste_dato] || 0) + 1;
        matrikler.add(d.matrikel);
      });

      // 2. Akkumuleret sum, hvor værdien holdes fra forrige dag
      let sidsteFundLastValue = 0;
      const sidsteFundLabels = labels; // Samme labels som ankomstgrafen
      // Akkumuler bagfra: hvor mange matrikler har stadig fund på eller efter denne dag
      const sidsteFundValues = labels.map(dato => 
        sidsteFundData.filter(f => {
          // Sammenlign dato-strenge som dd-mm-yyyy
          const [dd, mm, yyyy] = dato.split('-').map(Number);
          const d1 = new Date(yyyy, mm - 1, dd);
          const [fd, fm, fy] = f.sidste_dato.split('-').map(Number);
          const d2 = new Date(fy, fm - 1, fd);
          return d2 >= d1;
        }).length
      );

      // Find afgangsdage (dage hvor værdien falder ift. dagen før)
      const afgangDage = [];
      for (let i = 1; i < sidsteFundValues.length; i++) {
        if (sidsteFundValues[i] < sidsteFundValues[i - 1]) afgangDage.push(sidsteFundLabels[i]);
      }
      let medianAfgang = "-", pct20Afgang = "-";
      if (afgangDage.length) {
        const mid = Math.floor(afgangDage.length / 2);
        medianAfgang = afgangDage[mid];
        const idx = Math.ceil(afgangDage.length * 0.2) - 1;
        pct20Afgang = afgangDage[idx >= 0 ? idx : 0];
      }

      // 3. Tegn grafen
      const sidsteFundCtx2 = document.getElementById('sidsteFundChart').getContext('2d');
      if (sidsteFundChart) sidsteFundChart.destroy();
      sidsteFundChart = new Chart(sidsteFundCtx2, {
        type: 'line',
        data: {
          labels: sidsteFundLabels,
          datasets: [{
            label: 'Akkumuleret sidste fund',
            data: sidsteFundValues,
            borderColor: '#fe5f55',
            backgroundColor: 'rgba(254,95,85,0.10)',
            pointRadius: 3,
            fill: true,
            tension: 0
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, title: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Dato' } },
            y: {
              title: { display: true, text: 'Antal matrikler' },
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                callback: v => Number.isInteger(v) ? v : null
              }
            }
          }
        }
      });

      // --- Observationer pr. turid pr. dag ---
      const obs = data.obs_per_turid || [];
      // Brug ratio pr. dag fra obs_per_turid
      const ratioPerDate = {};
      for (const o of obs) {
        ratioPerDate[o.dato] = o.ratio;
      }
      // Konverter alleDage til dd-mm-yyyy format
      const turidLabels = alleDage.map(d => {
        const [day, month, year] = d.split('.');
        return `${day.padStart(2, '0')}-${month.padStart(2, '0')}-${year}`;
      });
      const turidValues = turidLabels.map(d => ratioPerDate[d] || 0);
      // Glidende gennemsnit (7 dage)
      function movingAverage(arr, windowSize) {
        const result = [];
        for (let i = 0; i < arr.length; i++) {
          const start = Math.max(0, i - windowSize + 1);
          const window = arr.slice(start, i + 1);
          const avg = window.reduce((a, b) => a + b, 0) / window.length;
          result.push(Number(avg.toFixed(2)));
        }
        return result;
      }
      const turidAvg = movingAverage(turidValues, 7);

      const turidCtx = document.getElementById('turidChart').getContext('2d');
      if (turidChart) turidChart.destroy();
      turidChart = new Chart(turidCtx, {
        type: 'line',
        data: {
          labels: turidLabels,
          datasets: [
            {
              label: 'Observationer pr. tur',
              data: turidValues,
              borderColor: '#3aafa9',
              backgroundColor: 'rgba(58,175,169,0.10)',
              pointRadius: 2,
              fill: true,
              tension: 0
            },
            {
              label: '7-dages glidende gennemsnit',
              data: turidAvg,
              type: 'line',
              borderColor: '#fe5f55',
              backgroundColor: 'rgba(254,95,85,0.10)',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              order: 2,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true }, title: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Dato' } },
            y: {
              title: { display: true, text: 'Antal observationer' },
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                callback: v => Number.isInteger(v) ? v : null
              }
            }
          }
        }
      });

      // Statistik
      const total = ankomstValues.length ? ankomstValues[ankomstValues.length - 1] : 0;
      const første = labels.find((_, i) => ankomstValues[i] > 0) || "-";
      const sidste = labels.length ? labels[labels.length - 1] : "-";

      // Udregn median og 20% ankomst ud fra ankomstdatoer for hver matrikel
      const ankomstDatoer = (ankomst || [])
        .map(a => a.ankomst_dato)
        .filter(Boolean)
        .sort((a, b) => {
          const [ad, am, ay] = a.split('-').map(Number);
          const [bd, bm, by] = b.split('-').map(Number);
          return new Date(ay, am - 1, ad) - new Date(by, bm - 1, bd);
        });

      let median = "-", pct20 = "-";
      if (ankomstDatoer.length) {
        const mid = Math.floor(ankomstDatoer.length / 2);
        median = ankomstDatoer[mid];
        const idx = Math.ceil(ankomstDatoer.length * 0.2) - 1;
        pct20 = ankomstDatoer[idx >= 0 ? idx : 0];
      }

      // Udregn gennemsnitlig ratio (kun dage med ratio > 0)
      const ratioValues = turidValues.filter(v => v > 0);
      const avgRatio = ratioValues.length ? (ratioValues.reduce((a, b) => a + b, 0) / ratioValues.length).toFixed(2) : "-";

    document.getElementById('statistik').innerHTML = `
      <div style="display:inline-block;text-align:left;padding:1.5em 2.5em;background:linear-gradient(120deg,#f8f8f8 80%,#e0f7fa 100%);border-radius:14px;box-shadow:0 2px 12px #0002;">
        <div style="font-size:1.3em;font-weight:bold;margin-bottom:0.7em;text-align:center;color:#2b7a78;">Statistik</div>
        <table style="border:none;font-size:1.08em;">
          <tr><td>Første fund:</td><td style="padding-left:1.5em;"><b>${første}</b></td></tr>
          <tr><td>Sidste fund:</td><td style="padding-left:1.5em;"><b>${sidste}</b></td></tr>
          <tr><td>Total antal matrikler:</td><td style="padding-left:1.5em;"><b>${total}</b></td></tr>
          <tr><td colspan="2" style="padding-top:1em;padding-bottom:0.5em;font-weight:bold;color:#2b7a78;">Ankomst</td></tr>
          <tr><td>Median ankomst:</td><td style="padding-left:1.5em;"><b>${median}</b></td></tr>
          <tr><td>20% ankomst:</td><td style="padding-left:1.5em;"><b>${pct20}</b></td></tr>
          <tr><td colspan="2" style="padding-top:1em;padding-bottom:0.5em;font-weight:bold;color:#fe5f55;">Afgang</td></tr>
          <tr><td>Median afgang:</td><td style="padding-left:1.5em;"><b>${medianAfgang}</b></td></tr>
          <tr><td>20% afgang:</td><td style="padding-left:1.5em;"><b>${pct20Afgang}</b></td></tr>
          <tr><td colspan="2" style="padding-top:1em;padding-bottom:0.5em;font-weight:bold;color:#3aafa9;">Observationer</td></tr>
          <tr><td>Gns. ratio pr. dag:</td><td style="padding-left:1.5em;"><b>${avgRatio}</b></td></tr>
        </table>
      </div>
    `;
    }

    document.getElementById('artDropdown').addEventListener('change', e => {
      hentArtData(e.target.value);
    });

    hentArter();
  </script>
</body>
</html>