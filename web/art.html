<!-- Version: 1.3.63 - 2026-01-05 14.37.38 -->
<!-- © Christian Vemmelund Helligsø -->
<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Ankomstgraf for fugle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css?v=1.3.63">
  <script src="https://cdn.jsdelivr.net/npm/chart.js?v=1.3.63"></script>
  <script type="module">
    import { renderNavbar, initNavbar, initMobileNavbar } from './navbar.js';
    renderNavbar();
    initNavbar();
    initMobileNavbar();

    fetch('/api/get_grupper', { credentials: 'include' })
    .then(res => res.json())
    .then(grupper => {
        import('./navbar.js').then(mod => {
        mod.addGruppeLinks(grupper);
        });
    });
  </script>
</head>
<body>
  <main style="max-width:600px;margin:40px auto;padding:2em 1em 1em 1em;background:var(--card-bg);border-radius:16px;box-shadow:var(--card-shadow)">
    <h2 style="text-align:center;">Ankomstgraf for fugle</h2>
    <div style="margin-bottom:1em;text-align:center;">
      <label for="artDropdown"><b>Vælg fugleart:</b></label>
      <select id="artDropdown" style="min-width:220px;padding:0.4em 0.7em;font-size:1em;"></select>
    </div>
    <canvas id="ankomstChart" width="500" height="300"></canvas>
    <div id="statistik" style="margin-top:1.5em;text-align:center;"></div>
  </main>
  <script>
    let chart = null;

    async function hentArter() {
      const res = await fetch('/api/matrikel_arter');
      const arter = await res.json();
      const dropdown = document.getElementById('artDropdown');
      dropdown.innerHTML = arter.map(a => `<option value="${a}">${a}</option>`).join('');
      if (arter.length) {
        dropdown.value = arter[0];
        hentArtData(arter[0]);
      }
    }

    async function hentArtData(artnavn) {
      const res = await fetch(`/api/artdata?artnavn=${encodeURIComponent(artnavn)}&scope=matrikel`);
      const data = await res.json();

      // Summér på dato
      const sumPerDate = {};
      let outData = Array.isArray(data) ? data : (data.out || []);
      for (const d of outData) {
        if (!sumPerDate[d.dato]) sumPerDate[d.dato] = 0;
        sumPerDate[d.dato] += 1;
      }

      // Find år og lav alle datoer fra 1. januar til i dag
      const today = new Date();
      const year = today.getFullYear();
      const startDate = new Date(year, 0, 1);
      const dateList = [];
      for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
        // Formatér til dd-mm-yyyy
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        dateList.push(`${dd}-${mm}-${yyyy}`);
      }

      // Akkumuleret optælling for alle dage
      let acc = 0;
      const out = dateList.map(dato => {
        if (sumPerDate[dato]) acc += sumPerDate[dato];
        return { dato: dato, antal: acc };
      });

      // For Chart.js
      const labels = out.map(d => d.dato);
      const values = out.map(d => d.antal);

      // Statistik
      const total = values.length ? values[values.length - 1] : 0;
      const første = labels.find((_, i) => values[i] > 0) || "-";
      const sidste = labels.length ? labels[labels.length - 1] : "-";

      // Find alle fund-datoer (hvor antallet stiger)
      const fundDage = [];
      for (let i = 1; i < values.length; i++) {
        if (values[i] > values[i - 1]) fundDage.push(labels[i]);
      }

      // Median
      let median = "-";
      if (fundDage.length) {
        const mid = Math.floor(fundDage.length / 2);
        median = fundDage[mid];
      }

      // 20% ankomst
      let pct20 = "-";
      if (fundDage.length) {
        const idx = Math.ceil(fundDage.length * 0.2) - 1;
        pct20 = fundDage[idx >= 0 ? idx : 0];
      }

      document.getElementById('statistik').innerHTML = `
        <b>${artnavn}</b>: <br>
        Første fund: <b>${første}</b> &nbsp;|&nbsp; Sidste fund: <b>${sidste}</b> <br>
        Total antal matrikler: <b>${total}</b><br>
        Median ankomst: <b>${median}</b><br>
        20% ankomst: <b>${pct20}</b>
      `;

      // Tegn graf
      const ctx = document.getElementById('ankomstChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `Akkumuleret ankomst (${artnavn})`,
            data: values,
            borderColor: '#2b7a78',
            backgroundColor: 'rgba(43,122,120,0.08)',
            pointRadius: 3,
            fill: true,
            tension: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: { title: { display: true, text: 'Dato' } },
            y: {
              title: { display: true, text: 'Antal matrikler' },
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                callback: function(value) {
                  return Number.isInteger(value) ? value : null;
                }
              }
            }
          }
        }
      });
    }

    document.getElementById('artDropdown').addEventListener('change', e => {
      hentArtData(e.target.value);
    });

    hentArter();
  </script>
</body>
</html>