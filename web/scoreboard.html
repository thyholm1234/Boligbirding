<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Scoreboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .user-card { border:1px solid #ccc; border-radius:8px; padding:1em; margin-bottom:1em; cursor:pointer; background:#f8f9fa; }
    .user-card:hover { background:#e0f7fa; }
    .firsts-list { margin:1em 0 2em 1em; padding-left:0; }
    .firsts-list li { margin-bottom:0.3em; }
    .modal-bg { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal { background:#fff; border-radius:10px; padding:2em; max-width:400px; width:90vw; }
  </style>
</head>
<body>
  <h1 id="page-title">Scoreboard</h1>
  <div id="main"></div>

  <div id="modal-bg" class="modal-bg" style="display:none;">
    <div class="modal">
      <button id="close-modal" style="float:right;">Luk</button>
      <h3 id="modal-title"></h3>
      <ul id="modal-list" class="firsts-list"></ul>
    </div>
  </div>

  <script>
  // --- Hjælpefunktion: Læs parametre fra URL ---
  function getParams() {
    const params = {};
    window.location.search.substring(1).split("&").forEach(pair => {
      const [k, v] = pair.split("=");
      if (k) params[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
    return params;
  }

  // --- Hent data fra API ---
  async function hentData(params) {
    let url, body;
    if (params.scope && params.scope.startsWith("user_")) {
      url = "/api/obser";
      body = params;
    } else {
      url = "/api/scoreboard";
      body = params;
    }
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    });
    return await res.json();
  }

  // --- Vis side dynamisk ---
  async function visSide() {
    const params = getParams();
    const data = await hentData(params);
    const container = document.getElementById("main");
    const pageTitle = document.getElementById("page-title");

    // Scoreboard
    if (!params.scope || !params.scope.startsWith("user_")) {
      const rows = data.rows || [];
      let title = "Scoreboard";
      if (params.scope === "lokal_matrikel") title += " – " + (params.afdeling || "");
      if (params.scope === "global_alle") title += " (Global)";
      if (params.scope === "global_matrikel") title += " (Global matrikel)";
      pageTitle.textContent = title;

      if (!rows.length) {
        container.innerHTML = "<p>Ingen brugere fundet.</p>";
        return;
      }
      let html = "";
      rows.forEach(row => {
        html += `
          <div class="user-card" data-obserkode="${row.obserkode}">
            <strong>#${row.placering} ${row.navn}</strong><br>
            Antal arter: ${row.antal_arter}<br>
            Sidste art: ${row.sidste_art ? row.sidste_art + (row.sidste_dato ? " (" + row.sidste_dato + ")" : "") : ""}
          </div>
        `;
      });
      container.innerHTML = html;

      // Klik på bruger åbner deres liste
      document.querySelectorAll('.user-card').forEach(card => {
        card.onclick = async function() {
          const kode = this.getAttribute('data-obserkode');
          // Åbn brugerens global-liste i modal
          await visUserFirsts(kode, this.querySelector('strong').innerText);
        };
      });
    }
    // Brugerliste
    else {
      const firsts = data.firsts || [];
      pageTitle.textContent = "Første observationer for " + (params.obserkode || "");
      if (!firsts.length) {
        container.innerHTML = "<p>Ingen observationer fundet.</p>";
      } else {
        container.innerHTML = `
          <ul class="firsts-list">
            ${firsts.map(f => `<li><strong>${f.artnavn}</strong> – ${f.lokalitet} – ${f.dato}</li>`).join("")}
          </ul>
          <button onclick="window.history.back()">Tilbage</button>
        `;
      }
    }
  }

  // --- Modal til brugerliste (fra scoreboard) ---
  async function visUserFirsts(obserkode, navn) {
    const res = await fetch('/api/obser', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        scope: 'user_global',
        obserkode: obserkode
      })
    });
    const data = await res.json();
    const firsts = data.firsts || [];
    const modalBg = document.getElementById('modal-bg');
    const modalTitle = document.getElementById('modal-title');
    const modalList = document.getElementById('modal-list');
    modalTitle.textContent = "Første observationer for " + navn;
    if (!firsts.length) {
      modalList.innerHTML = "<li>Ingen observationer fundet.</li>";
    } else {
      modalList.innerHTML = firsts.map(f =>
        `<li><strong>${f.artnavn}</strong> – ${f.lokalitet} – ${f.dato}</li>`
      ).join("");
    }
    modalBg.style.display = "flex";
  }

  document.getElementById('close-modal').onclick = function() {
    document.getElementById('modal-bg').style.display = "none";
  };
  window.onclick = function(e) {
    if (e.target.id === "modal-bg") {
      document.getElementById('modal-bg').style.display = "none";
    }
  };

  window.onload = visSide;
  </script>
</body>
</html>